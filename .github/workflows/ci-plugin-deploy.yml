# =============================================================================
# CI: Deploy Plugins to Dev
# =============================================================================
# Automatically deploys plugin assemblies and registers steps when plugin code
# changes are pushed to the develop branch.
#
# Flow:
#   1. Build plugin assemblies
#   2. Extract plugin registrations from compiled DLLs
#   3. Authenticate to Dev environment
#   4. Deploy assemblies using PAC CLI
#   5. Register/update steps using Web API
#
# This workflow complements the solution export workflow (ci-export.yml).
# Changes made here will be captured in the next nightly export.
#
# =============================================================================
# GITHUB ENVIRONMENT REQUIRED
# =============================================================================
#
# Dev Environment:
#   Variables:
#     - POWERPLATFORM_ENVIRONMENT_URL: https://orgXXXXX.crm.dynamics.com/
#     - POWERPLATFORM_TENANT_ID: your-tenant-id
#     - POWERPLATFORM_CLIENT_ID: your-service-principal-app-id
#   Secrets:
#     - POWERPLATFORM_CLIENT_SECRET: your-service-principal-secret
#
# =============================================================================

name: 'CI: Deploy Plugins to Dev'

on:
  push:
    branches: [develop]
    paths:
      - 'src/Plugins/**'
      - 'src/PluginPackages/**'

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      project:
        description: 'Specific project to deploy (leave empty for all)'
        required: false
        default: ''
      force:
        description: 'Remove orphaned steps'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'Dry run (WhatIf mode)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Dev

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET Framework compatibility
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.x'

      # Build plugins
      - name: Build PPDSDemo.Plugins
        run: dotnet build src/Plugins/PPDSDemo.Plugins/PPDSDemo.Plugins.csproj -c Release --nologo

      - name: Build PPDSDemo.PluginPackage
        run: dotnet build src/PluginPackages/PPDSDemo.PluginPackage/PPDSDemo.PluginPackage.csproj -c Release --nologo

      # Extract registrations from compiled assemblies
      - name: Extract plugin registrations
        shell: pwsh
        run: |
          ./tools/Extract-PluginRegistrations.ps1 -Verbose

      # Setup PAC CLI
      - name: Setup PAC CLI
        uses: joshsmithxrm/ppds-alm/.github/actions/setup-pac-cli@v1

      # Deploy plugins (auth is managed by pac-auth action)
      - name: Deploy plugins to Dev
        uses: joshsmithxrm/ppds-alm/.github/actions/pac-auth@v1
        with:
          environment-url: ${{ vars.POWERPLATFORM_ENVIRONMENT_URL }}
          tenant-id: ${{ vars.POWERPLATFORM_TENANT_ID }}
          client-id: ${{ vars.POWERPLATFORM_CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORM_CLIENT_SECRET }}
          run: |
            pwsh -Command '
              $params = @{
                Environment = "Dev"
                Verbose = $true
              }

              # Add project filter if specified
              if ("${{ github.event.inputs.project }}") {
                $params.Project = "${{ github.event.inputs.project }}"
              }

              # Add Force flag if specified
              if ("${{ github.event.inputs.force }}" -eq "true") {
                $params.Force = $true
              }

              # Add WhatIf flag if dry run
              if ("${{ github.event.inputs.dry_run }}" -eq "true") {
                $params.WhatIf = $true
              }

              ./tools/Deploy-Plugins.ps1 @params
            '

      # Summary
      - name: Deployment summary
        run: |
          echo "## Plugin Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Dev |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** This was a dry run. No changes were made." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The nightly export workflow will capture these registrations in the solution." >> $GITHUB_STEP_SUMMARY
