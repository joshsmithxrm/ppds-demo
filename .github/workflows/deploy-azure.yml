name: Deploy Azure Resources

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      deploy_infrastructure:
        description: 'Deploy infrastructure (Bicep)'
        required: false
        type: boolean
        default: false
      deploy_applications:
        description: 'Deploy applications'
        required: false
        type: boolean
        default: true

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # =============================================================================
  # Build Applications
  # =============================================================================
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_applications }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Web API
        run: dotnet build src/Api/PPDSDemo.Api/PPDSDemo.Api.csproj -c Release --no-restore

      - name: Publish Web API
        run: dotnet publish src/Api/PPDSDemo.Api/PPDSDemo.Api.csproj -c Release -o ${{ github.workspace }}/publish/api --no-build

      - name: Build Functions
        run: dotnet build src/Functions/PPDSDemo.Functions/PPDSDemo.Functions.csproj -c Release --no-restore

      - name: Publish Functions
        run: dotnet publish src/Functions/PPDSDemo.Functions/PPDSDemo.Functions.csproj -c Release -o ${{ github.workspace }}/publish/functions --no-build

      - name: Upload Web API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api
          path: ${{ github.workspace }}/publish/api

      - name: Upload Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: functions
          path: ${{ github.workspace }}/publish/functions
          include-hidden-files: true  # Required for .azurefunctions folder on Linux

  # =============================================================================
  # Deploy Infrastructure (using ppds-alm reusable workflow)
  # =============================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    if: ${{ inputs.deploy_infrastructure }}
    permissions:
      id-token: write
      contents: read
    uses: joshsmithxrm/ppds-alm/.github/workflows/azure-deploy.yml@v1
    with:
      environment: ${{ inputs.environment }}
      resource-group: rg-ppds-demo-${{ inputs.environment }}
      app-name-prefix: ppds-demo
      parameter-file: infra/${{ inputs.environment }}.parameters.json
      # Azure OIDC credentials are inputs (identifiers), not secrets (credentials)
      # OIDC authentication uses GitHub's token - no client secret needed
      azure-client-id: ${{ vars.AZURE_CLIENT_ID }}
      azure-tenant-id: ${{ vars.AZURE_TENANT_ID }}
      azure-subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

  # =============================================================================
  # Deploy Applications
  # =============================================================================
  deploy-applications:
    name: Deploy Applications
    runs-on: ubuntu-latest
    needs: [build, deploy-infrastructure]
    if: ${{ always() && inputs.deploy_applications && needs.build.result == 'success' && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') }}
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Download Web API artifact
        uses: actions/download-artifact@v4
        with:
          name: api
          path: ${{ github.workspace }}/publish/api

      - name: Download Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: functions
          path: ${{ github.workspace }}/publish/functions

      - name: Set App Names
        id: get-names
        run: |
          # Use deterministic naming based on CAF convention
          # No discovery needed - names are predictable from inputs
          WEB_APP="app-ppds-demo-${{ inputs.environment }}-001"
          FUNC_APP="func-ppds-demo-${{ inputs.environment }}-001"
          echo "webAppName=$WEB_APP" >> $GITHUB_OUTPUT
          echo "functionAppName=$FUNC_APP" >> $GITHUB_OUTPUT
          echo "Web App: $WEB_APP"
          echo "Function App: $FUNC_APP"

      - name: Deploy Web API
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.get-names.outputs.webAppName }}
          package: ${{ github.workspace }}/publish/api

      - name: Deploy Functions
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.get-names.outputs.functionAppName }}
          package: ${{ github.workspace }}/publish/functions

      # =========================================================================
      # Configure Managed Identity Authentication (Function -> Web API)
      # =========================================================================
      # These settings enable the Function App to authenticate to the Web API
      # using Managed Identity. The App Registration must be created first by
      # running the "Setup Azure AD (One-Time)" workflow.
      # =========================================================================

      - name: Get Azure AD Configuration
        id: azure-ad-config
        run: |
          ENV="${{ inputs.environment }}"
          ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')

          # Get environment-specific variables
          # These are set by the setup-azure-ad.yml workflow
          CLIENT_ID_VAR="AZURE_WEBAPI_CLIENT_ID_${ENV_UPPER}"
          AUDIENCE_VAR="AZURE_WEBAPI_AUDIENCE_${ENV_UPPER}"

          # Read from GitHub Variables (passed via vars context)
          case "$ENV" in
            dev)
              CLIENT_ID="${{ vars.AZURE_WEBAPI_CLIENT_ID_DEV }}"
              AUDIENCE="${{ vars.AZURE_WEBAPI_AUDIENCE_DEV }}"
              ;;
            qa)
              CLIENT_ID="${{ vars.AZURE_WEBAPI_CLIENT_ID_QA }}"
              AUDIENCE="${{ vars.AZURE_WEBAPI_AUDIENCE_QA }}"
              ;;
            prod)
              CLIENT_ID="${{ vars.AZURE_WEBAPI_CLIENT_ID_PROD }}"
              AUDIENCE="${{ vars.AZURE_WEBAPI_AUDIENCE_PROD }}"
              ;;
          esac

          if [ -z "$CLIENT_ID" ]; then
            echo "::warning::Azure AD not configured for $ENV environment. Run 'Setup Azure AD (One-Time)' workflow first."
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
            echo "audience=$AUDIENCE" >> $GITHUB_OUTPUT
            echo "Azure AD configured: Client ID = $CLIENT_ID"
          fi

      - name: Configure Web API Authentication
        if: steps.azure-ad-config.outputs.configured == 'true'
        run: |
          echo "Configuring Web API with Azure AD settings..."
          az webapp config appsettings set \
            --name ${{ steps.get-names.outputs.webAppName }} \
            --resource-group rg-ppds-demo-${{ inputs.environment }} \
            --settings \
              "AzureAd__ClientId=${{ steps.azure-ad-config.outputs.client_id }}" \
              "AzureAd__TenantId=${{ vars.AZURE_TENANT_ID }}" \
            --output none

          echo "Web API configured with Azure AD authentication"

      - name: Configure Function App Authentication
        if: steps.azure-ad-config.outputs.configured == 'true'
        run: |
          echo "Configuring Function App with Web API audience..."
          az functionapp config appsettings set \
            --name ${{ steps.get-names.outputs.functionAppName }} \
            --resource-group rg-ppds-demo-${{ inputs.environment }} \
            --settings \
              "WebApiAudience=${{ steps.azure-ad-config.outputs.audience }}" \
            --output none

          echo "Function App configured with Web API audience"

      - name: Deployment Summary
        run: |
          echo "## Application Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web API | \`${{ steps.get-names.outputs.webAppName }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | \`${{ steps.get-names.outputs.functionAppName }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Managed Identity Authentication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.azure-ad-config.outputs.configured }}" == "true" ]; then
            echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Status | :white_check_mark: Configured |" >> $GITHUB_STEP_SUMMARY
            echo "| Web API Client ID | \`${{ steps.azure-ad-config.outputs.client_id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Function Audience | \`${{ steps.azure-ad-config.outputs.audience }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo ":warning: **Not configured** - Run the 'Setup Azure AD (One-Time)' workflow first." >> $GITHUB_STEP_SUMMARY
          fi
