# Tools Reference

PowerShell scripts for deploying and managing the PPDSDemo solution. These scripts wrap the **PPDS.Tools** PowerShell module for deployment automation.

---

## Prerequisites

Install the PPDS.Tools module before using deployment scripts:

```powershell
Install-Module PPDS.Tools -Scope CurrentUser
```

---

## Script Overview

| Script | Purpose |
|--------|---------|
| `Deploy-Plugins.ps1` | Deploy plugin assemblies and register steps |
| `Extract-PluginRegistrations.ps1` | Generate registrations.json from compiled assemblies |
| `Generate-Entities.ps1` | Generate early-bound entity classes |
| `Deploy-Components.ps1` | Deploy plugins and web resources together |
| `Create-SchemaComponents.ps1` | Create tables, option sets, environment variables |
| `Add-MissingSolutionComponents.ps1` | Add existing components to solution |
| `Generate-Snk.ps1` | Generate strong name key file for assembly signing |
| `Setup-BranchProtection.ps1` | Configure GitHub branch protection rules via gh CLI |

---

## Deploy-Plugins.ps1

Deploys plugin assemblies to Dataverse and registers/updates plugin steps.

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `-Environment` | String | Target environment: `Dev` (default), `QA`, `Prod` |
| `-Project` | String | Specific project to deploy (deploys all if not specified) |
| `-Force` | Switch | Remove orphaned steps not in configuration |
| `-WhatIf` | Switch | Preview changes without deploying |
| `-Build` | Switch | Build projects before deployment |
| `-Interactive` | Switch | Use browser-based OAuth login |

### Examples

```powershell
# Deploy all plugins to Dev using .env.dev credentials
.\tools\Deploy-Plugins.ps1

# Deploy with browser-based login
.\tools\Deploy-Plugins.ps1 -Interactive

# Deploy specific project to QA
.\tools\Deploy-Plugins.ps1 -Environment QA -Project PPDSDemo.Plugins

# Preview what would be deployed
.\tools\Deploy-Plugins.ps1 -WhatIf

# Build and deploy, removing orphaned steps
.\tools\Deploy-Plugins.ps1 -Build -Force
```

---

## Extract-PluginRegistrations.ps1

Extracts plugin step registrations from compiled assemblies using .NET reflection. Outputs `registrations.json` files used by `Deploy-Plugins.ps1`.

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `-Project` | String | Specific project to extract (extracts all if not specified) |
| `-Build` | Switch | Build projects before extraction |

### Examples

```powershell
# Extract registrations from all plugin projects
.\tools\Extract-PluginRegistrations.ps1

# Build and extract from specific project
.\tools\Extract-PluginRegistrations.ps1 -Project PPDSDemo.Plugins -Build
```

### Output

Creates `registrations.json` in each plugin project directory:

```
src/Plugins/PPDSDemo.Plugins/
├── PPDSDemo.Plugins.csproj
├── registrations.json          # Generated by this script
└── Plugins/
    └── AccountCreatePlugin.cs
```

---

## Generate-Entities.ps1

Regenerates early-bound entity classes from Dataverse using `pac modelbuilder`.

### Prerequisites

- PAC CLI authenticated (`pac auth create`)
- Active environment selected (`pac org select`)

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `-Entities` | String | Semicolon-separated entity logical names. Default: `account;contact` |
| `-IncludeGlobalOptionSets` | Switch | Include all global option sets. Default: `$true` |
| `-IncludeSdkMessages` | Switch | Include SDK message classes. Default: `$false` |

### Examples

```powershell
# Generate default entities (account, contact)
.\tools\Generate-Entities.ps1

# Generate specific entities including custom ones
.\tools\Generate-Entities.ps1 -Entities "account;contact;ppds_demoentity;ppds_demochild"

# Generate with SDK message classes
.\tools\Generate-Entities.ps1 -IncludeSdkMessages
```

### Output

Generates files in `src/Shared/PPDSDemo.Entities/`:

```
src/Shared/PPDSDemo.Entities/
├── PPDSDemo.Entities.csproj
├── Entities/
│   ├── Account.cs
│   └── Contact.cs
└── OptionSets/
    └── *.cs
```

---

## Deploy-Components.ps1

Deploys both plugins and web resources in a single operation.

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `-Environment` | String | Target environment: `Dev`, `QA`, `Prod` |
| `-WhatIf` | Switch | Preview changes without deploying |
| `-Interactive` | Switch | Use browser-based OAuth login |

### Examples

```powershell
# Deploy all components to Dev
.\tools\Deploy-Components.ps1

# Preview deployment to QA
.\tools\Deploy-Components.ps1 -Environment QA -WhatIf
```

---

## Create-SchemaComponents.ps1

Creates Dataverse schema components (tables, columns, option sets, environment variables) from configuration files.

### Examples

```powershell
# Create schema components in Dev environment
.\tools\Create-SchemaComponents.ps1 -Environment Dev
```

---

## Add-MissingSolutionComponents.ps1

Adds existing Dataverse components to the solution. Useful when components exist in the environment but aren't in the solution.

### Examples

```powershell
# Add missing components to solution
.\tools\Add-MissingSolutionComponents.ps1
```

---

## Generate-Snk.ps1

Generates a strong name key (.snk) file for assembly signing.

### Examples

```powershell
# Generate new key file
.\tools\Generate-Snk.ps1
```

### Output

Creates `PPDSDemo.snk` in the repository root. This file should be committed to source control (it contains only the public key used for signing, not secrets).

---

## Setup-BranchProtection.ps1

Configures GitHub branch protection rules using the GitHub CLI (`gh`).

### Prerequisites

- GitHub CLI installed and authenticated (`gh auth login`)
- Repository admin permissions

### Examples

```powershell
# Configure branch protection for main and develop
.\tools\Setup-BranchProtection.ps1
```

See [BRANCH_PROTECTION_GUIDE.md](../guides/BRANCH_PROTECTION_GUIDE.md) for manual setup instructions.

---

## Authentication

Scripts authenticate to Dataverse using environment files or interactive login.

### Environment Files

Create `.env.{environment}` files (e.g., `.env.dev`, `.env.qa`, `.env.prod`):

```ini
# .env.dev
DATAVERSE_URL=https://orgXXXXX.crm.dynamics.com
SP_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
SP_APPLICATION_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
SP_CLIENT_SECRET=your-secret-here
```

| Variable | Description | Required |
|----------|-------------|----------|
| `DATAVERSE_URL` | Environment URL | Yes |
| `SP_TENANT_ID` | Azure AD Tenant ID | For service principal auth |
| `SP_APPLICATION_ID` | App Registration Client ID | For service principal auth |
| `SP_CLIENT_SECRET` | App Registration Secret | For service principal auth |

See [.env.example](../../.env.example) for a complete template.

### Authentication Methods

```powershell
# Service principal (from .env file) - recommended for automation
.\tools\Deploy-Plugins.ps1 -Environment Dev

# Interactive OAuth - for local development
.\tools\Deploy-Plugins.ps1 -Interactive
```

---

## Common Workflows

### Initial Setup

```powershell
# 1. Install PPDS.Tools
Install-Module PPDS.Tools -Scope CurrentUser

# 2. Copy and configure environment file
Copy-Item .env.example .env.dev
# Edit .env.dev with your credentials

# 3. Build solution
dotnet build src/Plugins/PPDSDemo.Plugins/PPDSDemo.Plugins.csproj -c Release

# 4. Extract registrations
.\tools\Extract-PluginRegistrations.ps1

# 5. Deploy to Dev
.\tools\Deploy-Plugins.ps1
```

### After Plugin Changes

```powershell
# Build, extract, and deploy
dotnet build src/Plugins/PPDSDemo.Plugins -c Release
.\tools\Extract-PluginRegistrations.ps1
.\tools\Deploy-Plugins.ps1
```

### Regenerate Entities After Schema Changes

```powershell
# Ensure PAC CLI is authenticated
pac auth create --environment https://orgXXXXX.crm.dynamics.com

# Regenerate
.\tools\Generate-Entities.ps1 -Entities "account;contact;ppds_newentity"
```

---

## Security Practices

### Do

- Use `.env.{environment}` files for credentials (gitignored)
- Use service principals for automation
- Use `-WhatIf` to preview changes before deploying
- Validate connection before performing work

### Don't

- Hardcode credentials in scripts
- Commit `.env` files with secrets
- Use `-Interactive` in CI/CD pipelines
- Share service principal secrets via email or chat

---

## See Also

- [ENVIRONMENT_SETUP_GUIDE.md](../guides/ENVIRONMENT_SETUP_GUIDE.md) - Setting up environments and service principals
- [PAC_CLI_REFERENCE.md](PAC_CLI_REFERENCE.md) - PAC CLI commands
- [PLUGIN_COMPONENTS_REFERENCE.md](PLUGIN_COMPONENTS_REFERENCE.md) - Plugin assembly vs package structure
